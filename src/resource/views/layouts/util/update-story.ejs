<!DOCTYPE html>
<html
	lang="en"
	class="light-style customizer-hide"
	dir="ltr"
	data-theme="theme-default"
	data-template="vertical-menu-template-free"
>
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
		/>

		<title>Tea Loza</title>

		<meta name="description" content="" />

		<!-- Favicon -->
		<link rel="icon" type="image/x-icon" href="/img/favicon.ico" />

		<!-- Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
			rel="stylesheet"
		/>

		<!-- Icons. Uncomment required icon fonts -->
		<link rel="stylesheet" href="/lib/fonts/boxicons.css" />
		<link rel="stylesheet" href="/css/bootstrap.min.css" />

		<!-- Core CSS -->
		<link rel="stylesheet" href="/css/core.css" class="template-customizer-core-css" />
		<link rel="stylesheet" href="/css/theme-default.css" class="template-customizer-theme-css" />
		<link rel="stylesheet" href="/css/demo.css" />

		<!-- Vendors CSS -->
		<link rel="stylesheet" href="/lib/perfect-scrollbar/perfect-scrollbar.css" />
		<link rel="stylesheet" href="/css/vendors/buttons.bootstrap4.css" />
		<link rel="stylesheet" href="/css/vendors/dataTables.bootstrap4.css" />
		<link rel="stylesheet" href="/css/vendors/select.bootstrap4.css" />
		<!-- Page CSS -->
		<!-- Page -->
		<link rel="stylesheet" href="/css/pages/page-auth.css" />
		<link rel="stylesheet" href="/css/pages/page-ticket.css" />
		<!--    <link rel="stylesheet" href="/css/icons.min.css">-->
		<!--    <link rel="stylesheet" href="/css/pages/page-datatable.css">-->
		<!-- Helpers -->
		<script src="/js/admin/helpers.js"></script>

		<!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
		<!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
		<script src="/js/admin/config.js"></script>
	</head>
	<body>
		<!-- BEGIN: Content-->
		<div class="layout-wrapper layout-content-navbar">
			<div class="layout-container">
				<%- include('../../partials/admin/menubar.ejs', { active: 'tickets', sub: 'team-members' }) %>
				<div class="layout-page">
					<!-- Navbar -->

					<nav
						class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
						id="layout-navbar"
					>
						<div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
							<a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
								<i class="bx bx-menu bx-sm"></i>
							</a>
						</div>

						<div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
							<!-- Search -->
							<div class="navbar-nav align-items-center">
								<div class="nav-item d-flex align-items-center">
									<i class="bx bx-search fs-4 lh-0"></i>
									<input
										type="text"
										class="form-control border-0 shadow-none"
										placeholder="Search..."
										aria-label="Search..."
									/>
								</div>
							</div>
							<!-- /Search -->

							<ul class="navbar-nav flex-row align-items-center ms-auto">
								<!-- Place this tag where you want the button to render. -->
								<li class="nav-item lh-1 me-3">
									<a
										class="github-button"
										href="https://github.com/themeselection/sneat-html-admin-template-free"
										data-icon="octicon-star"
										data-size="large"
										data-show-count="true"
										aria-label="Star themeselection/sneat-html-admin-template-free on GitHub"
										>Star</a
									>
								</li>

								<!-- User -->
								<li class="nav-item navbar-dropdown dropdown-user dropdown">
									<a
										class="nav-link dropdown-toggle hide-arrow"
										href="javascript:void(0);"
										data-bs-toggle="dropdown"
									>
										<div class="avatar avatar-online">
											<img src="<%= user.avatar %>" alt class="w-px-40 h-auto rounded-circle" />
										</div>
									</a>
									<ul class="dropdown-menu dropdown-menu-end">
										<li>
											<a class="dropdown-item" href="#">
												<div class="d-flex">
													<div class="flex-shrink-0 me-3">
														<div class="avatar avatar-online">
															<img
																src="<%= user.avatar %>"
																alt
																class="w-px-40 h-auto rounded-circle"
															/>
														</div>
													</div>
													<div class="flex-grow-1">
														<span class="fw-semibold d-block"
															><%= user.name || user.email %></span
														>
														<small class="text-muted"><%= user.role %></small>
													</div>
												</div>
											</a>
										</li>
										<li>
											<div class="dropdown-divider"></div>
										</li>
										<li>
											<a class="dropdown-item" href="#">
												<i class="bx bx-user me-2"></i>
												<span class="align-middle">My Profile</span>
											</a>
										</li>
										<li>
											<a class="dropdown-item" href="#">
												<i class="bx bx-cog me-2"></i>
												<span class="align-middle">Settings</span>
											</a>
										</li>
										<li>
											<a class="dropdown-item" href="#">
												<span class="d-flex align-items-center align-middle">
													<i class="flex-shrink-0 bx bx-credit-card me-2"></i>
													<span class="flex-grow-1 align-middle">Billing</span>
													<span
														class="flex-shrink-0 badge badge-center rounded-pill bg-danger w-px-20 h-px-20"
														>4</span
													>
												</span>
											</a>
										</li>
										<li>
											<div class="dropdown-divider"></div>
										</li>
										<li>
											<a class="dropdown-item logout" href="/auth/logout/<%= user.id %>">
												<i class="bx bx-power-off me-2"></i>
												<span class="align-middle">Log Out</span>
											</a>
										</li>
									</ul>
								</li>
								<!--/ User -->
							</ul>
						</div>
					</nav>

					<!-- / Navbar -->

					<!-- Content wrapper -->
					<div class="content-wrapper">
						<div class="container-xxl flex-grow-1 container-p-y">
							<div class="row my-3 d-flex justify-content-between">
								<div class="col d-flex justify-content-between">
									<a href="/admin/stories" role="button" class="btn btn-outline-dark">
										<i class="bx bx-arrow-back"></i> Back
									</a>

									<button type="button" class="btn btn-primary btn-save-story">
										<i class="bx bx-save"></i> Save Story
									</button>
								</div>
							</div>

							<div class="row mb-1" data-story-id=" <%= story ? story.id : '' %>"> 
								<div class="mb-2 w-100">
									<div class="divider">
										<div class="divider-text">
											<i class="bx bxs-coffee-togo"></i>
										</div>
									</div>
								</div>
								<div class="col">
									<div class="m-0">
										<input
											name="title"
											class="form-control form-control-md display-3 text-center p-0 my-2"
											type="text"
											placeholder="Story title "
											style="font-size: 2rem"
											<% if (story) { %> value="<%= story.title %>" <% } %> 
										/>
										<textarea
											name="sortDescription"
											class="form-control my-2"
											id="exampleFormControlTextarea1"
											rows="6"
											placeholder="Story sort description"
										><%= story ? story.sortDescription : '' %>
									</textarea>
									</div>
								</div>
							</div>
							<select name="" id="" class="form-select tag">
								<option value="">Select Tag</option>
								<% tags.forEach(tag => { %>
									<option value="<%= tag.id %>" <%= story && story.tag.id === tag.id ? 'selected' : ''%> > <%= tag.name %> </option>
								<% })%>
							</select>
							<div class="divider">
								<div class="divider-text">CONTENT</div>
							</div>

							<div class="row my-2">
								<div class="col">
									<button type="button" class="btn btn-secondary btn-add-block">
										Add New Block <i class="bx bx-plus"></i>
									</button>
								</div>
							</div>

							<div class="block-list m-0">
								<% if (story) { %>
									<% story.blockContent.forEach(block => { %>
										<% let index = story.blockContent.indexOf(block) %>
										<div class="block card p-3 my-3">
											<div class="row">
												<div class="col">
													<div class="m-0">
														<input
															id="largeInput"
															class="form-control form-control-lg display-3 mb-2 block-title"
															type="text"
															placeholder="Block title"
															<% if (block) { %> value="<%= block.title %>" <% } %> 
														/>
														<textarea
															class="form-control block-content"
															id="exampleFormControlTextarea1"
															rows="5"
															placeholder="Block description"
														><%= block ? block.content : '' %>
													</textarea>
													</div>
													<div class="m-0">
														<button class="btn-delete-block btn btn-outline-danger mt-2" data-bs-toggle="modal"
																data-bs-target="#confirmDeleteBlock">
															<i class="bx bx-trash"></i> Delete Block
														</button>
													</div>
												</div>
												<div class="col">
													<div
														class="text-center d-flex justify-content-center flex-column align-items-center"
													>
														<img
															<% if (block) { %> 
																src="<%= block.url %>" 
															<% } else { %> 
																src="/img/placeholder-image.png" 
															<% } %>
															class="mb-2 block-image"
															width="90%"
															min-height="180px"
															height="180px"
															style="object-fit: cover"
															alt="Product-img"
														/>
													</div>

													<div
														class="w-auto mb-0 d-inline w-100 image_status d-flex justify-content-center"
													>
														<label
															type="button"
															class="btn btn-primary waves-effect waves-light"
															for="uploadImageInput-<%= index %>"
														>
															<i class="bx bx-upload me-2"></i>
															<span>Upload Image</span>
															<input
																type="file"
																class="d-none block-image-input uploadImage"
																id="uploadImageInput-<%= index++ %>"
																name="uploadImage"
																accept="image/*"
															/>
														</label>
													</div>
												</div>
											</div>
										</div>
									<% }) %>
								<% } %>
							</div>
						</div>

						<form>
							<div class="modal fade" id="confirmDeleteBlock" tabindex="-1" aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="modalCenterTitle">Cofirm Delete</h5>
											<button
												type="button"
												class="btn-close"
												data-bs-dismiss="modal"
												aria-label="Close"
											></button>
										</div>
										<div class="modal-body">
											<div class="row">
												<div class="col">
													<h5>Are you sure you want to delete this block?</h5>
												</div>
											</div>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
												Cancel
											</button>
											<button type="button" class="btn btn-danger btn-confirm-delete">
												<i class="bx bx-trash"></i> Delete
											</button>
										</div>
									</div>
								</div>
							</div>
						</form>

						<div class="bs-toast toast toast-placement-ex m-2 fade bg-success top-0 end-0 hide" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
							<div class="toast-header">
							<i class="bx bx-bell me-2"></i>
							<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
							</div>
							<div class="toast-body">Fruitcake chocolate bar tootsie roll gummies gummies jelly beans cake.</div>
						</div>

						<div class="content-backdrop fade"></div>
					</div>
					<!-- Content wrapper -->
				</div>
				<!-- Layout page -->
			</div>

			<!-- Overlay -->
			<div class="layout-overlay layout-menu-toggle"></div>

			<div class="layout-overlay layout-loading d-none">
				<div class="spinner-border text-primary"></div>
				<span class="ml-2">Loading...</span>
			</div>
		</div>

		<!-- Core JS -->
		<!-- build:js assets/vendor/js/core.js -->
		<script src="/lib/jquery/jquery.js"></script>
		<script src="/lib/popper/popper.js"></script>
		<script src="/lib/bootstrap/bootstrap.js"></script>
		<script src="/lib/perfect-scrollbar/perfect-scrollbar.js"></script>

		<script src="/lib/bootstrap/menu.js"></script>
		<!-- endbuild -->
		<script src="/lib/apex-charts/apexcharts.js"></script>
		<!-- Vendors JS -->

		<!-- Main JS -->
		<script src="/js/admin/main.js"></script>
		<script src="/js/utils/auth/logout.js"></script>

		<!-- Page JS -->
		<script src="/js/utils/auth/dashboards-analytics.js"></script>
		<script src="/js/utils/ui/extended-ui-perfect-scrollbar.js"></script>

		<script src="/lib/datatables/jquery.dataTables.min.js"></script>
		<script src="/lib/datatables/dataTables.bootstrap4.js"></script>
		<script src="/lib/datatables/dataTables.buttons.min.js"></script>
		<script src="/lib/datatables/dataTables.checkboxes.min.js"></script>
		<script src="/lib/datatables/dataTables.keyTable.min.js"></script>
		<script src="/lib/datatables/dataTables.responsive.min.js"></script>
		<script src="/lib/datatables/dataTables.select.min.js"></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"
			integrity="sha512-JRlcvSZAXT8+5SQQAvklXGJuxXTouyq8oIMaYERZQasB8SBDHZaUbeASsJWpk0UUrf89DP3/aefPPrlMR1h1yQ=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>

		<!-- Place this tag in your head or just before your close body tag. -->
		<script async defer src="https://buttons.github.io/buttons.js"></script>

		<script>
			//    add new block
			const blockList = $(".block-list");
			const btnAddBlock = $(".btn-add-block");

			const allBlocks = $(".block");
			for(let i = 0; i < allBlocks.length; i++) {
				const block = $(allBlocks[i]);
				block.find(".btn-delete-block").click(function () {
					const block = $(this).parents(".block");
					const btnConfirmDelete = $(".btn-confirm-delete");
					const modalConfirmDelete = $("#confirmDeleteBlock");
					btnConfirmDelete.click(function () {
						block.remove();
						modalConfirmDelete.modal("hide");
					});
				});

				// add event listener for upload image this block
				block.find(".block-image-input").change(function () {
					console.log("change image");
					const block = $(this).parents(".block");

					const reader = new FileReader();
					reader.onload = function (e) {
						block.find(".block-image").attr("src", e.target.result);
					};

					reader.readAsDataURL(this.files[0]);
				});
			}


			btnAddBlock.click(function (e) {
				const blockNumber = $(".block").length;
				blockList.append(renderBlock(blockNumber));
				
				const lastBlock = $(".block").last();
				console.log(lastBlock);
				lastBlock.find(".btn-delete-block").click(function () {
					const block = $(this).parents(".block");
					const btnConfirmDelete = $(".btn-confirm-delete");
					const modalConfirmDelete = $("#confirmDeleteBlock");
					btnConfirmDelete.click(function () {
						block.remove();
						modalConfirmDelete.modal("hide");
					});
				});

				// add event listener for upload image this block
				lastBlock.find(".block-image-input").change(function () {
					console.log("change image");
					const block = $(this).parents(".block");

					const reader = new FileReader();
					reader.onload = function (e) {
						block.find(".block-image").attr("src", e.target.result);
					};

					reader.readAsDataURL(this.files[0]);
				});
			});

			//    delete block
			function deleteBlock() {
				const modalConfirmDelete = $("#confirmDeleteBlock");
				const btnDeleteBlock = $(".btn-delete-block");
				const btnConfirmDelete = $(".btn-confirm-delete");
				console.log("delete block");
				console.log(btnDeleteBlock.length);
				btnDeleteBlock.click(function () {
					const block = $(this).parents(".block");
					btnConfirmDelete.click(function () {
						block.remove();
						modalConfirmDelete.modal("hide");
					});
				});
			}

			function renderBlock(index = 0) {
				let block = `
			<div class="block card p-3 my-3">
				<div class="row">
					<div class="col">
						<div class="m-0">
							<input
								id="largeInput"
								class="form-control form-control-lg display-3 mb-2 block-title"
								type="text"
								placeholder="Block title"
							/>
							<textarea
								class="form-control block-content"
								id="exampleFormControlTextarea1"
								rows="5"
								placeholder="Block description"
							></textarea>
						</div>
						<div class="m-0">
							<button class="btn-delete-block btn btn-outline-danger mt-2" data-bs-toggle="modal"
									data-bs-target="#confirmDeleteBlock">
								<i class="bx bx-trash"></i> Delete Block
							</button>
						</div>
					</div>
					<div class="col">
						<div
							class="text-center d-flex justify-content-center flex-column align-items-center"
						>
							<img
								src="/img/placeholder.jpg"
								class="mb-2 block-image"
								width="90%"
								min-height="180px"
								height="180px"
								style="object-fit: cover"
								alt="Product-img"
							/>
						</div>

						<div
							class="w-auto mb-0 d-inline w-100 image_status d-flex justify-content-center"
						>
							<label
								type="button"
								class="btn btn-primary waves-effect waves-light"
								for="uploadImageInput-${index}"
							>
								<i class="bx bx-upload me-2"></i>
								<span>Upload Image</span>
								<input
									type="file"
									class="d-none block-image-input uploadImage"
									id="uploadImageInput-${index}"
									name="uploadImage"
									accept="image/*"
								/>
							</label>
						</div>
					</div>
				</div>
			</div>
			`;

				return block;
			}

			// ajax save story
			const btnSaveStory = $(".btn-save-story");
			const storyTitle = $("input[name='title']");
			const storySortDescription = $("textarea[name='sortDescription']");
			const tag = $(".tag");
			btnSaveStory.click(function () {
				let blockContent = [];
				$(".block").each(function () {
					let block = {
						title: $(this).find(".block-title").val(),
						content: $(this).find(".block-content").val().trim(),
						url: $(this).find(".block-image").attr("src"),
					};
					blockContent.push(block);
				});
				console.log("SAVE STORY");
				let data = {
					title: storyTitle.val(),
					sortDescription: storySortDescription.val().trim(),
					blockContent: blockContent,
					tag: tag.val(),
				};
				console.log(data);

				$.ajax({
					url: "/admin/stories/update/<%= story.id %>",
					type: "PUT",
					data: JSON.stringify(data),
					contentType: "application/json",
					beforeSend: function () {
						$(".layout-loading").removeClass("d-none");

					},
					success: function (res) {
						if(res.status === 200) {
							$(".layout-loading").removeClass("d-block");
							$(".layout-loading").addClass("d-none");
							console.log("Toast success")
							const toast = $(".toast");
							const toastBody = $(".toast-body");
							toastBody.html(res.message);
							toast.removeClass("hide");
							toast.addClass("show");
							setTimeout(() => {
								toast.removeClass("show");
								toast.addClass("hide");
							}, 3000);
						}
					},
					error: function (err) {
						$(".layout-loading").removeClass("d-block");
						$(".layout-loading").addClass("d-none");
						console.log(err.responseJSON)
						const toast = $(".toast");
						const toastBody = $(".toast-body");
						$(toast).removeClass("bg-success");
						$(toast).addClass("bg-danger");
						toastBody.html(err.responseText);
						toast.removeClass("hide");
						toast.addClass("show");
						setTimeout(() => {
							toast.removeClass("show");
							toast.addClass("hide");
						}, 3000);
					},
				});
			});
		</script>
	</body>
</html>
